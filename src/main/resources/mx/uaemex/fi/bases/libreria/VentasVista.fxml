<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.Button?>
<?import javafx.scene.control.CheckBox?>
<?import javafx.scene.control.ComboBox?>
<?import javafx.scene.control.DatePicker?>
<?import javafx.scene.control.Label?>
<?import javafx.scene.control.Separator?>
<?import javafx.scene.control.SplitPane?>
<?import javafx.scene.control.Tab?>
<?import javafx.scene.control.TabPane?>
<?import javafx.scene.control.TableColumn?>
<?import javafx.scene.control.TableView?>
<?import javafx.scene.control.TextField?>
<?import javafx.scene.control.Tooltip?>
<?import javafx.scene.layout.HBox?>
<?import javafx.scene.layout.Region?>
<?import javafx.scene.layout.VBox?>
<?import javafx.scene.text.Font?>

<VBox xmlns="http://javafx.com/javafx/17" xmlns:fx="http://javafx.com/fxml/1"
      fx:controller="mx.uaemex.fi.bases.libreria.controlador.VentasControlador"
      style="-fx-background-color: #ecf0f1;" prefWidth="1200" prefHeight="700">

    <!-- ENCABEZADO COMÃšN -->
    <HBox alignment="CENTER_LEFT" spacing="15" style="-fx-background-color: #2c3e50; -fx-padding: 15;">
        <Button text="â¬… Regresar" onAction="#regresarMenu"
                style="-fx-background-color: transparent; -fx-text-fill: white; -fx-border-color: white; -fx-border-radius: 3; -fx-cursor: hand;"/>
        <Label text="GestiÃ³n de Ventas" textFill="white">
            <font><Font name="Segoe UI Bold" size="22.0"/></font>
        </Label>
        <Region HBox.hgrow="ALWAYS"/>
        <Label fx:id="lblEmpleado" text="Cajero: ..." textFill="#bdc3c7" style="-fx-font-weight: bold;"/>
    </HBox>

    <!-- SISTEMA DE PESTAÃ‘AS -->
    <TabPane tabClosingPolicy="UNAVAILABLE" VBox.vgrow="ALWAYS">

        <!-- ================= PESTAÃ‘A 1: NUEVA VENTA (POS) ================= -->
        <Tab text="ðŸ›’ Nueva Venta (POS)">
            <SplitPane dividerPositions="0.55" style="-fx-background-color: transparent;">

                <!-- IZQUIERDA: CATÃLOGO -->
                <VBox spacing="10" style="-fx-padding: 15;">
                    <Label text="1. Buscar Productos" style="-fx-font-weight: bold; -fx-font-size: 14; -fx-text-fill: #2c3e50;"/>

                    <HBox spacing="10" alignment="CENTER_LEFT" style="-fx-background-color: white; -fx-padding: 10; -fx-background-radius: 5;">
                        <TextField fx:id="txtBuscarLibro" promptText="Escribe tÃ­tulo o ISBN..." HBox.hgrow="ALWAYS"/>
                        <Button text="ðŸ” Buscar" onAction="#buscarLibros" style="-fx-background-color: #3498db; -fx-text-fill: white;"/>
                        <Button text="Ver Todos" onAction="#recargarLibros"/>
                    </HBox>

                    <TableView fx:id="tblCatalogoLibros" VBox.vgrow="ALWAYS">
                        <columns>
                            <TableColumn fx:id="colCatTitulo" text="TÃ­tulo" prefWidth="250"/>
                            <TableColumn fx:id="colCatAutor" text="Autor" prefWidth="150"/>
                            <TableColumn fx:id="colCatPrecio" text="Precio" prefWidth="80"/>
                            <TableColumn fx:id="colCatAnio" text="AÃ±o" prefWidth="60"/>
                        </columns>
                    </TableView>

                    <!-- CAMPO CANTIDAD -->
                    <HBox alignment="CENTER_RIGHT" spacing="10" style="-fx-background-color: white; -fx-padding: 10; -fx-background-radius: 5;">
                        <Label text="Cantidad:" style="-fx-font-weight: bold;"/>
                        <TextField fx:id="txtCantidadAgregar" text="1" prefWidth="60" alignment="CENTER"/>
                        <Button text="Agregar al Carrito âž¡" onAction="#agregarAlCarrito"
                                style="-fx-background-color: #27ae60; -fx-text-fill: white; -fx-font-weight: bold; -fx-font-size: 13px; -fx-cursor: hand;"/>
                    </HBox>
                </VBox>

                <!-- DERECHA: CARRITO Y PAGO -->
                <VBox spacing="15" style="-fx-padding: 15; -fx-background-color: white;">

                    <VBox spacing="5" style="-fx-background-color: #f8f9fa; -fx-padding: 10; -fx-border-color: #bdc3c7; -fx-border-radius: 5;">
                        <Label text="2. Datos de Cliente" style="-fx-font-weight: bold; -fx-text-fill: #2c3e50;"/>
                        <HBox spacing="10" alignment="CENTER_LEFT">
                            <Label text="Cliente:"/>
                            <ComboBox fx:id="cmbCliente" promptText="Seleccione Cliente" maxWidth="Infinity" HBox.hgrow="ALWAYS"/>
                        </HBox>
                        <HBox spacing="10" alignment="CENTER_LEFT">
                            <Label text="Pago:"/>
                            <ComboBox fx:id="cmbMetodoPago" promptText="Forma de Pago..." maxWidth="Infinity" HBox.hgrow="ALWAYS"/>
                        </HBox>
                    </VBox>

                    <Label text="3. Carrito de Compras" style="-fx-font-weight: bold; -fx-text-fill: #2c3e50;"/>
                    <TableView fx:id="tblCarrito" VBox.vgrow="ALWAYS">
                        <columns>
                            <TableColumn fx:id="colCarTitulo" text="Libro" prefWidth="200"/>
                            <TableColumn fx:id="colCarCantidad" text="Cant." prefWidth="60"/>
                            <TableColumn fx:id="colCarPrecio" text="P. Unit" prefWidth="80"/>
                            <TableColumn fx:id="colCarImporte" text="Importe" prefWidth="90"/>
                        </columns>
                    </TableView>

                    <HBox spacing="10">
                        <Button text="Quitar Item" onAction="#quitarDelCarrito" style="-fx-text-fill: #e74c3c; -fx-background-color: transparent; -fx-border-color: #e74c3c;"/>
                        <Region HBox.hgrow="ALWAYS"/>
                        <Button text="Vaciar Carrito" onAction="#vaciarCarrito" style="-fx-text-fill: #7f8c8d;"/>
                    </HBox>

                    <Separator/>

                    <VBox alignment="CENTER_RIGHT" spacing="5">
                        <HBox alignment="CENTER_RIGHT" spacing="10">
                            <Label text="Total a Pagar:" style="-fx-font-size: 18px;"/>
                            <Label fx:id="lblTotalVenta" text="'$0.00'" style="-fx-font-size: 28px; -fx-font-weight: bold; -fx-text-fill: #27ae60;"/>
                        </HBox>
                    </VBox>

                    <Button text="COBRAR" onAction="#realizarVenta"
                            maxWidth="Infinity" prefHeight="50"
                            style="-fx-background-color: #2980b9; -fx-text-fill: white; -fx-font-weight: bold; -fx-font-size: 16px; -fx-cursor: hand; -fx-effect: dropshadow(three-pass-box, rgba(0,0,0,0.2), 5, 0, 0, 2);"/>

                    <Label fx:id="lblMensaje" alignment="CENTER" maxWidth="Infinity" wrapText="true"/>
                </VBox>
            </SplitPane>
        </Tab>

        <!-- ================= PESTAÃ‘A 2: HISTORIAL DE VENTAS ================= -->
        <Tab text="ðŸ“œ Historial y Consultas">
            <VBox spacing="15" style="-fx-padding: 15;">
                <!-- FILTROS AVANZADOS -->
                <VBox spacing="10" style="-fx-background-color: white; -fx-padding: 15; -fx-background-radius: 5; -fx-effect: dropshadow(three-pass-box, rgba(0,0,0,0.1), 3, 0, 0, 1);">
                    <Label text="Filtros de BÃºsqueda" style="-fx-font-weight: bold; -fx-text-fill: #7f8c8d;"/>

                    <HBox spacing="15" alignment="CENTER_LEFT">
                        <VBox spacing="2">
                            <Label text="ID Venta:"/>
                            <TextField fx:id="txtHistIdVenta" prefWidth="60" promptText="#"/>
                        </VBox>
                        <!-- NUEVO: CAMPO LIBRO -->
                        <VBox spacing="2">
                            <Label text="Libro Incluido:"/>
                            <TextField fx:id="txtHistLibro" promptText="TÃ­tulo..." prefWidth="150"/>
                        </VBox>
                        <VBox spacing="2">
                            <Label text="Cliente:"/>
                            <TextField fx:id="txtHistCliente" promptText="Nombre..."/>
                        </VBox>
                        <VBox spacing="2">
                            <Label text="Empleado:"/>
                            <TextField fx:id="txtHistEmpleado" promptText="Nombre..."/>
                        </VBox>
                        <VBox spacing="2">
                            <Label text="MÃ©todo Pago:"/>
                            <ComboBox fx:id="cmbHistMetodo" prefWidth="120"/>
                        </VBox>
                    </HBox>

                    <Separator/>

                    <HBox spacing="20" alignment="CENTER_LEFT">
                        <HBox spacing="5" alignment="CENTER_LEFT">
                            <Label text="Fecha:"/>
                            <DatePicker fx:id="dpFechaInicio" prefWidth="110" promptText="Desde"/>
                            <Label text="-"/>
                            <DatePicker fx:id="dpFechaFin" prefWidth="110" promptText="Hasta"/>
                        </HBox>

                        <HBox spacing="5" alignment="CENTER_LEFT">
                            <Label text="Total ($):"/>
                            <TextField fx:id="txtHistMinTotal" prefWidth="70" promptText="Min"/>
                            <Label text="-"/>
                            <TextField fx:id="txtHistMaxTotal" prefWidth="70" promptText="Max"/>
                        </HBox>

                        <Region HBox.hgrow="ALWAYS"/>
                        <Label fx:id="lblTotalVentas" text="Encontradas: 0" style="-fx-font-weight: bold; -fx-text-fill: #2980b9; -fx-padding: 5 10 0 0;"/>

                        <!-- NUEVO: BOTÃ“N LIMPIAR -->
                        <Button text="Limpiar" onAction="#limpiarHistorial" style="-fx-background-color: #e74c3c; -fx-text-fill: white;"/>
                        <Button text="ðŸ” Buscar Ventas" onAction="#buscarHistorialVentas" style="-fx-background-color: #3498db; -fx-text-fill: white; -fx-font-weight: bold;"/>
                    </HBox>
                </VBox>

                <!-- TABLA HISTORIAL -->
                <TableView fx:id="tblHistorialVentas" VBox.vgrow="ALWAYS">
                    <columns>
                        <TableColumn fx:id="colHistId" text="ID" prefWidth="50"/>
                        <TableColumn fx:id="colHistFecha" text="Fecha" prefWidth="150"/>
                        <TableColumn fx:id="colHistCliente" text="Cliente" prefWidth="200"/>
                        <TableColumn fx:id="colHistEmpleado" text="Atendido por" prefWidth="150"/>
                        <TableColumn fx:id="colHistMetodo" text="Pago" prefWidth="100"/>
                        <TableColumn fx:id="colHistTotal" text="Total" prefWidth="100"/>
                        <TableColumn fx:id="colHistEstado" text="Estado" prefWidth="80"/>
                    </columns>
                </TableView>

                <HBox alignment="CENTER_RIGHT" spacing="10">
                    <!-- NUEVO: BOTÃ“N VER DETALLES -->
                    <Button text="ðŸ“„ Ver Detalles (Ticket)" onAction="#verDetallesVenta" style="-fx-background-color: #f39c12; -fx-text-fill: white; -fx-font-weight: bold;"/>
                    <Button text="âŒ Cancelar Venta Seleccionada" onAction="#cancelarVentaHistorial" style="-fx-background-color: #c0392b; -fx-text-fill: white;"/>
                </HBox>
            </VBox>
        </Tab>
    </TabPane>
</VBox>